@using System.Globalization
@using System.Security.Claims
@using FirstWebApplication.Helpers 
@model FirstWebApplication.Models.Obstacle.ObstacleDetailsViewModel

@{
    ViewData["Title"] = "Obstacle Overview";
    var formattedHeight = Model.Height.ToString("F2", CultureInfo.InvariantCulture); 
    
    var registeredByDisplay = !string.IsNullOrEmpty(Model.RegisteredBy)
        ? Model.RegisteredBy
        : User.Identity?.Name ?? "Ukjent bruker";
}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="~/css/pilot/overview.css" />

<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Obstacle Details #@Model.Id</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
        
        <div class="space-y-6">
            <div class="details-card">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Informasjon</h2>
                <div class="detail-row"><div class="detail-label">ID:</div><div class="detail-value">#@Model.Id</div></div>
                
                <div class="detail-row"><div class="detail-label">Status:</div>
                    <div class="detail-value">
                        @if (Model.IsApproved) { <span class="status-badge status-approved">Godkjent</span> }
                        else if (Model.IsRejected) { <span class="status-badge status-rejected">Avvist</span> }
                        else { <span class="status-badge status-pending">Venter p√• svar</span> }
                    </div>
                </div>

                <div class="detail-row"><div class="detail-label">Type:</div><div class="detail-value">@(Model.Type ?? "Ukjent")</div></div>
                <div class="detail-row"><div class="detail-label">H√∏yde:</div><div class="detail-value">@formattedHeight m</div></div>
                
                <div class="detail-row">
                    <div class="detail-label">Posisjon:</div>
                    <div class="detail-value text-sm break-all">
                        @{
                           var rawLoc = Model.Location ?? "";
                           if (rawLoc.Contains("POINT")) {
                               var clean = rawLoc.Replace("POINT", "").Replace("(", "").Replace(")", "").Trim();
                               var parts = clean.Split(' ');
                               if(parts.Length == 2) {
                                   <span>üìç Lat: @parts[1], Lon: @parts[0]</span>
                               } else { <span>@rawLoc</span> }
                           } else { <span>@rawLoc</span> }
                       }
                    </div>
                </div>
                
                <div class="detail-row"><div class="detail-label">Beskrivelse:</div><div class="detail-value">@Model.Description</div></div>
                <div class="detail-row"><div class="detail-label">Dato:</div><div class="detail-value">@Model.RegisteredDate.ToString("dd.MM.yyyy HH:mm")</div></div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="details-card">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Kartvisning</h2>
                
                <div id="map" 
                     style="height: 400px; width: 100%; border: 1px solid #ccc; border-radius: 8px; z-index: 1;"
                     data-id="@Model.Id"
                     data-geometry="@Model.Location"
                     data-height="@formattedHeight">
                     <div style="padding: 20px; text-align: center; color: gray;">Laster kart...</div>
                </div>
            </div>

            <div class="flex flex-col gap-4">
                <a asp-action="MyRegistrations" class="text-center px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition">Tilbake</a>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script @Html.Raw(Html.NonceAttribute())>
    document.addEventListener('DOMContentLoaded', function () {
        console.log("üöÄ Kart-script startet!");

        var mapElement = document.getElementById('map');
        if (!mapElement) { console.error("Fant ikke kart-div"); return; }

        // T√∏m "Laster kart..." teksten
        mapElement.innerHTML = "";

        var geometry = mapElement.getAttribute('data-geometry');
        var id = mapElement.getAttribute('data-id');
        var height = mapElement.getAttribute('data-height');

        // Initialiser kartet
        var map = L.map('map').setView([65.0, 13.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Fiks for visningsfeil
        setTimeout(function() { map.invalidateSize(); }, 200);

        if (geometry) {
            try {
                var layer;
                if (geometry.includes('POINT')) {
                    var clean = geometry.replace(/POINT|\(|\)/g, '').trim();
                    var parts = clean.split(' ');
                    var lng = parseFloat(parts[0]);
                    var lat = parseFloat(parts[1]);

                    if (!isNaN(lat) && !isNaN(lng)) {
                        layer = L.marker([lat, lng]).addTo(map);
                        map.setView([lat, lng], 13);
                    }
                } 
                else if (geometry.includes('LINESTRING')) {
                    var clean = geometry.replace(/LINESTRING|\(|\)/g, '').trim();
                    var pairs = clean.split(',');
                    var latlngs = pairs.map(function(pair) {
                        var p = pair.trim().split(' ');
                        return [parseFloat(p[1]), parseFloat(p[0])];
                    });
                    layer = L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);
                    map.fitBounds(layer.getBounds());
                }

                if (layer) {
                    layer.bindPopup("<b>Obstacle #" + id + "</b><br>Height: " + height + "m").openPopup();
                }
            } catch (e) {
                console.error("Feil i kart-data:", e);
            }
        }
    });
</script>