@model FirstWebApplication.Models.Obstacle.CompleteQuickRegViewModel

@{
    ViewData["Title"] = "Complete Your Registration";
}

<style>
    #mapid {
        height: 450px;
        width: 100%;
    }
</style>

<div class="max-w-4xl mx-auto px-4 py-8 bg-white rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-2 text-center text-gray-800">Complete Your Registration</h1>
    <p class="text-gray-600 mb-6 text-center">Fill in the missing details for your obstacle registration</p>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="mb-4 p-4 bg-green-100 border-l-4 border-green-500 text-green-700">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
            @TempData["ErrorMessage"]
        </div>
    }

    <form asp-action="CompleteQuickRegister" method="post" class="space-y-6">
        
        <input type="hidden" asp-for="ObstacleId" />
        <input type="hidden" asp-for="ObstacleGeometry" />

        <div>
            <label asp-for="ObstacleType" class="block text-sm font-medium mb-1 text-gray-700">Obstacle Type:</label>
            <select asp-for="ObstacleType" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" id="obstacleTypeSelect" onchange="toggleCustomType()">
                <option value="">-- Select Type --</option>
                <option value="Mast">Mast</option>
                <option value="Tower">Tower</option>
                <option value="Power Line">Power Line</option>
                <option value="Wind Turbine">Wind Turbine</option>
                <option value="Building">Building</option>
                <option value="Crane">Crane</option>
                <option value="Bridge">Bridge</option>
                <option value="Other">Other</option>
            </select>
            <span asp-validation-for="ObstacleType" class="text-sm text-red-600"></span>
        </div>

        <div id="customTypeGroup" style="display: none;">
            <label for="customTypeName" class="block text-sm font-medium mb-1 text-gray-700">Specify Type:</label>
            <input type="text" id="customTypeName" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Enter custom obstacle type..." />
        </div>

        <div>
            <label asp-for="ObstacleName" class="block text-sm font-medium mb-1 text-gray-700">Name: *</label>
            <input asp-for="ObstacleName" placeholder="E.g., Radio Tower" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            <span asp-validation-for="ObstacleName" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label asp-for="ObstacleHeight" class="block text-sm font-medium mb-1 text-gray-700">Height (meters): *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" placeholder="E.g., 50" class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600" />
            <span asp-validation-for="ObstacleHeight" class="text-sm text-red-600"></span>
        </div>

        <div>
            <label asp-for="ObstacleDescription" class="block text-sm font-medium mb-1 text-gray-700">Description: *</label>
            <textarea asp-for="ObstacleDescription" rows="4" placeholder="Describe the obstacle..." class="w-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-600"></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-sm text-red-600"></span>
        </div>

        <!-- Map showing saved location -->
        <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">Location (Already Saved):</label>
            <div id="mapid" class="rounded-lg border border-gray-300"></div>
            <p class="text-sm text-gray-600 mt-2">üìç The location you marked is shown on the map above.</p>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition">
                ‚úÖ Complete Registration
            </button>
            <a asp-action="MyRegistrations" class="flex-1 text-center bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 rounded-lg transition">
                Cancel
            </a>
        </div>
    </form>
</div>

@section Scripts {
    <link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />
    <script src="~/lib/leaflet/leaflet.js"></script>

    <script>
        // Toggle custom type input field
        function toggleCustomType() {
            var select = document.getElementById('obstacleTypeSelect');
            var customGroup = document.getElementById('customTypeGroup');
            var customInput = document.getElementById('customTypeName');

            if (select.value === 'Other') {
                customGroup.style.display = 'block';
                customInput.required = true;
            } else {
                customGroup.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Update obstacle type with custom value before form submit
        document.querySelector('form').addEventListener('submit', function(e) {
            var select = document.getElementById('obstacleTypeSelect');
            var customInput = document.getElementById('customTypeName');

            if (select.value === 'Other' && customInput.value.trim()) {
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'CustomObstacleType';
                hiddenInput.value = customInput.value.trim();
                this.appendChild(hiddenInput);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            var map = L.map('mapid').setView([60.4720, 8.4689], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Get saved geometry from model
            var geometryWKT = '@Model.ObstacleGeometry';
            
            if (geometryWKT) {
                try {
                    if (geometryWKT.startsWith('POINT')) {
                        var coords = geometryWKT.replace('POINT(', '').replace(')', '').split(' ');
                        var lat = parseFloat(coords[1]);
                        var lng = parseFloat(coords[0]);
                        
                        var marker = L.marker([lat, lng]).addTo(map);
                        map.setView([lat, lng], 13);
                    } else if (geometryWKT.startsWith('LINESTRING')) {
                        var coordsStr = geometryWKT.replace('LINESTRING(', '').replace(')', '');
                        var coordPairs = coordsStr.split(',');
                        var latlngs = coordPairs.map(pair => {
                            var coords = pair.trim().split(' ');
                            return [parseFloat(coords[1]), parseFloat(coords[0])];
                        });
                        
                        var polyline = L.polyline(latlngs, {color: 'blue'}).addTo(map);
                        map.fitBounds(polyline.getBounds());
                    } else if (geometryWKT.startsWith('POLYGON')) {
                        var coordsStr = geometryWKT.replace('POLYGON((', '').replace('))', '');
                        var coordPairs = coordsStr.split(',');
                        var latlngs = coordPairs.map(pair => {
                            var coords = pair.trim().split(' ');
                            return [parseFloat(coords[1]), parseFloat(coords[0])];
                        });
                        
                        var polygon = L.polygon(latlngs, {color: 'blue'}).addTo(map);
                        map.fitBounds(polygon.getBounds());
                    }
                } catch (e) {
                    console.error('Error parsing geometry:', e);
                }
            }
        });
    </script>
}
