@model FirstWebApplication.Models.Obstacle.RegisterObstacleViewModel

@{
    ViewData["Title"] = "Full Registration";
}

@section Head {
    <link rel="stylesheet" href="~/lib/leaflet/leaflet.css" />

    <style>
        #map {
            position: absolute;
            top: 64px;
            left: 0;
            right: 400px;
            bottom: 0;
            z-index: 0;
        }

        .registration-form {
            position: absolute;
            top: 64px;
            right: 0;
            width: 400px;
            height: calc(100vh - 64px);
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }

        /* Tablet and mobile responsive */
        @@media (max-width: 1024px) {
            #map {
                position: relative;
                top: 0;
                right: 0;
                left: 0;
                width: 100%;
                height: 50vh;
            }

            .registration-form {
                position: relative;
                top: 0;
                width: 100%;
                height: auto;
                min-height: 50vh;
            }
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .text-danger {
            color: #dc3545;
            font-size: 0.875rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-location {
            background-color: #10b981;
            color: white;
            margin-bottom: 15px;
            width: 100%;
        }

        .btn-location:hover {
            background-color: #059669;
        }

        .btn-location:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
}

<div id="map"></div>

<div class="registration-form">
    <h2 class="text-2xl font-bold mb-4">Full Registration</h2>
    <p class="text-gray-600 mb-4">Fill in all details and mark the location on the map.</p>

    <button type="button" id="useLocationBtn" class="btn btn-location" onclick="useMyLocation()">
        Use My Location
    </button>

    <form asp-action="FullRegister" method="post">
        <div class="form-group">
            <label asp-for="ObstacleType">Obstacle Type:</label>
            <select asp-for="ObstacleType" class="form-control" id="obstacleTypeSelect" onchange="toggleCustomType()">
                <option value="">-- Select Type --</option>
                <option value="Mast">Mast</option>
                <option value="Tower">Tower</option>
                <option value="Power Line">Power Line</option>
                <option value="Wind Turbine">Wind Turbine</option>
                <option value="Building">Building</option>
                <option value="Crane">Crane</option>
                <option value="Bridge">Bridge</option>
                <option value="Other">Other</option>
            </select>
            <span asp-validation-for="ObstacleType" class="text-danger"></span>
        </div>

        <div class="form-group" id="customTypeGroup" style="display: none;">
            <label for="customTypeName">Specify Type:</label>
            <input type="text" id="customTypeName" class="form-control" placeholder="Enter custom obstacle type..." />
        </div>

        <div class="form-group">
            <label asp-for="ObstacleName">Name: *</label>
            <input asp-for="ObstacleName" class="form-control" placeholder="E.g., Radio Tower" />
            <span asp-validation-for="ObstacleName" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ObstacleHeight">Height (meters): *</label>
            <input asp-for="ObstacleHeight" type="number" step="0.1" class="form-control" placeholder="E.g., 50" />
            <span asp-validation-for="ObstacleHeight" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ObstacleDescription">Description: *</label>
            <textarea asp-for="ObstacleDescription" class="form-control" rows="4" placeholder="Describe the obstacle..."></textarea>
            <span asp-validation-for="ObstacleDescription" class="text-danger"></span>
        </div>

        <input type="hidden" asp-for="ObstacleGeometry" id="obstacleGeometryInput" />
        <span asp-validation-for="ObstacleGeometry" class="text-danger"></span>

        <button type="submit" class="btn btn-primary w-100">Submit Registration</button>
        <a asp-action="RegisterType" class="btn btn-secondary w-100">Cancel</a>
    </form>
</div>

@section Scripts {
    <script>
        // Global variables for map access
        var map;
        var drawnItems;

        // Toggle custom type input field
        function toggleCustomType() {
            var select = document.getElementById('obstacleTypeSelect');
            var customGroup = document.getElementById('customTypeGroup');
            var customInput = document.getElementById('customTypeName');

            if (select.value === 'Other') {
                customGroup.style.display = 'block';
                customInput.required = true;
            } else {
                customGroup.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Use device GPS location
        function useMyLocation() {
            var btn = document.getElementById('useLocationBtn');

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Getting location...';

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;

                    // Place marker using the global function
                    if (window.placeMarkerOnMap) {
                        window.placeMarkerOnMap(lat, lng);
                    }

                    btn.disabled = false;
                    btn.textContent = 'Use My Location';
                },
                function(error) {
                    btn.disabled = false;
                    btn.textContent = 'Use My Location';

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            alert('Location access denied. Please enable location permissions.');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            alert('Location information is unavailable.');
                            break;
                        case error.TIMEOUT:
                            alert('Location request timed out.');
                            break;
                        default:
                            alert('An unknown error occurred getting your location.');
                            break;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Update obstacle type with custom value before form submit
        document.querySelector('form').addEventListener('submit', function(e) {
            var select = document.getElementById('obstacleTypeSelect');
            var customInput = document.getElementById('customTypeName');

            if (select.value === 'Other' && customInput.value.trim()) {
                // Create a hidden input with the custom type value
                var hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'CustomObstacleType';
                hiddenInput.value = customInput.value.trim();
                this.appendChild(hiddenInput);
            }
        });

        // Initialize map after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('map').setView([60.4720, 8.4689], 6);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            var currentMarker = null;

            // Function to place or move marker
            function placeMarker(latlng) {
                if (currentMarker) {
                    // Move existing marker
                    currentMarker.setLatLng(latlng);
                } else {
                    // Create new draggable marker
                    currentMarker = L.marker(latlng, { draggable: true }).addTo(drawnItems);

                    // Update coordinates when marker is dragged
                    currentMarker.on('dragend', function(e) {
                        var pos = e.target.getLatLng();
                        document.getElementById('obstacleGeometryInput').value = `POINT(${pos.lng} ${pos.lat})`;
                    });
                }

                // Update geometry input
                document.getElementById('obstacleGeometryInput').value = `POINT(${latlng.lng} ${latlng.lat})`;
            }

            // Click on map to place/move marker
            map.on('click', function(e) {
                placeMarker(e.latlng);
            });

            // Make placeMarker available globally for useMyLocation
            window.placeMarkerOnMap = function(lat, lng) {
                var latlng = L.latLng(lat, lng);
                placeMarker(latlng);
                map.setView(latlng, 15);
            };
        });
    </script>
}
